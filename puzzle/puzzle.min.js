function compareRandom(t,e){return Math.random()-.5}!function(){"use strict";window.Util={randint:function(t){return~~(Math.random()*t)}},"bind"in Function||(Function.prototype.bind=function(t){var e=this;return function(){return e.apply(t,arguments)}});for(var t,e=Class.extend({init:function(t){this.elem=document.getElementById(t)}}),i=document.addEventListener?function(t,e,i){t.addEventListener(e,i,!1)}:function(t,e,i){t.attachEvent("on"+e,(function(t){return(t=t||void 0).preventDefault=t.preventDefault||function(){this.returnValue=!1},t.stopPropagation=t.stopPropagation||function(){this.cancelBubble=!0},i.call(t.target||t.srcElement,t)}))},s="mousemove mouseover mouseout mousedown mouseup click touchstart dblclick focus blur submit change".split(" "),n=0;n<s.length;n++){var o=s[n];e.prototype[o]=function(t){return function(e,s){"function"==typeof e?i(this.elem,t,e):i(this.elem,t,(function(t){var i=t.target||t.srcElement;i.tagName.toLowerCase()==e&&(t.stopPropagation(),s.call(i,t))}),!1)}}(o)}Util.fullScreen=function(){document.documentElement.scrollHeight<window.outerHeight/window.devicePixelRatio?(document.body.style.height=window.outerHeight/window.devicePixelRatio+1+"px",setTimeout((function(){window.scrollTo(1,1)}),0)):window.scrollTo(1,1)},Util.getContext=function(t){return!t.getContext&&window.G_vmlCanvasManager&&G_vmlCanvasManager.initElement(t),t.getContext("2d")},Util.extend=function(t,e){var i;for(i in e)e.hasOwnProperty(i)&&!(i in t)&&(t[i]=e[i]);return t},Util.calcPieces=function(t){var e,i,s=t.image.width,n=t.image.height,o=document.getElementById("set-parts");o.selectedIndex;o.innerHTML="";for(var h=0;h<t.options.length;h+=1){for(var a,r=~~(s/(a=~~Math.sqrt(s*n/t.options[h]))),c=~~(n/a);r*c<t.options[h];)r=~~(s/--a),c=~~(n/a);i!=r*c&&(i=r*c,(e=document.createElement("option")).value=t.options[h],o.selectedIndex=partsindex,e.innerHTML=t.template.replace("%d",i),o.appendChild(e),t.options[h]===t.selected&&(e.selected=!0))}},Util.addEvent=i,Util.$=(t=e(),function(e){return t.elem=document.getElementById(e),t})}(),function(){"use strict";var t=Util.getContext(document.createElement("canvas")),e=Math.abs,i=Math.PI/180,s=Util.getContext(document.createElement("canvas"));function n(){return window.devicePixelRatio||1}var o=navigator.userAgent,h=o.match(/android/i),a=o.match(/iphone|ipad|ipod/i),r=o.match(/Windows Phone/i)||o.match(/iemobile/i),c=!h&&!a&&!r,d=20;function l(t,i){if(!(t.rotation%360||i.rotation%360||i.hide||t.hide||t.row!=i.row&&t.col!=i.col)){var s=t.tx-i.tx,n=t.ty-i.ty,o=t.col-i.col,h=t.row-i.row,a=t.width,r=t.height;t.size;return(-1==o&&s<0&&e(s+a)<d||1==o&&s>=0&&e(s-a)<d)&&n<=d&&n>=-20?[t.col>i.col?-e(s)+a:e(s)-a,i.ty-t.ty]:(-1==h&&n<0&&e(n+r)<d||1==h&&n>=0&&e(n-r)<d)&&s<=d&&s>=-20?[i.tx-t.tx,t.row>i.row?-e(n)+r:e(n)-r]:void 0}}var u=Cevent.Shape.extend({type:"piece",init:function(t,e,i,s,n,o,h){this.flat=h,this._super(t,e),this.img=i,this.originalImg=i,this.size=Math.max(s,n),this.width=s,this.height=n,this.diagonal=~~Math.sqrt(s*s+n*n),this.edges=o,this.lastRotation=0;this.size;this.tx=this.x+this.width/2,this.ty=this.y+this.height/2,this.x=-this.width/2,this.y=-this.height/2},draw_path:function(t){var e,i=this.size,s=0;for(t.beginPath(),t.moveTo(this.x,this.y);s<4;s++){e=this.edges[s],i=s%2?this.height:this.width;var n=s%2?this.height:this.width,o=s%2?this.width:this.height,h=s%2?this.y:this.x,a=s%2?this.x:this.y;if(e)this[e](t,n,o,h,a);else t.lineTo(h+i,a);t.rotate(Math.PI/2)}t.closePath()},render:function(t,e){t=t||this.ox||0,e=e||this.oy||0,this.originalTX=this.originalTX||this.tx,this.originalTY=this.originalTY||this.ty;var n=this.ctx||Util.getContext(document.createElement("canvas")),o=this.size+.5;s.canvas.width=n.canvas.width=2*o,s.canvas.height=n.canvas.height=2*o,s.save(),n.save(),this.applyStyle(n),s.lineWidth=.5,n.lineWidth=.5,n.translate(this.width,this.height),n.rotate(this.rotation*i),s.translate(this.width,this.height),s.rotate(this.rotation*i),this.draw_path(n),this.draw_path(s),n.fill(),s.mozImageSmoothingEnabled=!1,s.webkitImageSmoothingEnabled=!1,s.msImageSmoothingEnabled=!1,s.imageSmoothingEnabled=!1,s.drawImage(this.originalImg,-this.originalTX-t,-this.originalTY-e),this.stroke&&(s.globalCompositeOperation="lighter",s.shadowOffsetY=.5,s.shadowOffsetX=.5,s.shadowBlur=0,s.shadowColor="rgba(255, 255, 255, .6)",s.lineWidth=1.5,s.strokeStyle="rgba(0, 0, 0, .45)",s.stroke(),s.globalCompositeOperation="darken",s.shadowBlur=1,s.shadowOffsetY=-1,s.shadowOffsetX=-1,s.shadowBlur=2,s.shadowColor="rgba(0, 0, 0, .2)",s.lineWidth=.75,s.strokeStyle="rgba(0, 0, 0, .85)",s.stroke(),s.clip()),s.restore(),n.restore(),n.globalCompositeOperation="source-in","source-in"!==n.globalCompositeOperation&&(n.globalCompositeOperation="source-atop"),n.drawImage(s.canvas,0,0),this.ctx||(this.tx+=this.offset),this.img=n.canvas,this.ctx=n,this.ox=t,this.oy=e},outside:function(t,e,i,s,n){if(this.flat)return t.lineTo(s+e,n);t.lineTo(s+.34*e,n),t.bezierCurveTo(s+.5*e,n,s+.4*e,n+-.15*i,s+.4*e,n+-.15*i),t.bezierCurveTo(s+.3*e,n+-.3*i,s+.5*e,n+-.3*i,s+.5*e,n+-.3*i),t.bezierCurveTo(s+.7*e,n+-.3*i,s+.6*e,n+-.15*i,s+.6*e,n+-.15*i),t.bezierCurveTo(s+.5*e,n,s+.65*e,n,s+.65*e,n),t.lineTo(s+e,n)},inside:function(t,e,i,s,n){if(this.flat)return t.lineTo(s+e,n);t.lineTo(s+.35*e,n),t.bezierCurveTo(s+.505*e,n+.05,s+.405*e,n+.155*i,s+.405*e,n+.1505*i),t.bezierCurveTo(s+.3*e,n+.3*i,s+.5*e,n+.3*i,s+.5*e,n+.3*i),t.bezierCurveTo(s+.7*e,n+.29*i,s+.6*e,n+.15*i,s+.6*e,n+.15*i),t.bezierCurveTo(s+.5*e,n,s+.65*e,n,s+.65*e,n),t.lineTo(s+e,n)},draw:function(t){if(!this.hide){var e=this.x-this.width/2-.5,i=this.y-this.height/2-.5;if(c)return this.setTransform(t),t.mozImageSmoothingEnabled=!1,t.webkitImageSmoothingEnabled=!1,t.msImageSmoothingEnabled=!1,t.imageSmoothingEnabled=!1,void t.drawImage(this.img,e,i);this.rotation!==this.lastRotation&&(this.render(),this.lastRotation=this.rotation),t.drawImage(this.img,e+this.tx,i+this.ty)}},check:function(t){var e;if("piece"==t.type)e=l(this,t);else{var i,s=t.pieces.length;for(i=0;i<s&&!(e=l(this,t.pieces[i]));i++);}return e&&this.rmove(e[0],e[1]),e},hitTest:function(e){if(!this.hide)return this.setTransform(t),this.draw_path(t),t.isPointInPath(e.x*n(),e.y*n())}}),m=Cevent.Shape.extend({type:"group",init:function(){this.pieces=[],this._super(0,0)},draw:function(t){if(!this.hide){var e,i=this.pieces.length;for(e=0;e<i;e++)this.pieces[e].draw(t)}},hitTest:function(t){var e,i=this.pieces.length;for(e=0;e<i;e++)if(this.pieces[e].hitTest(t))return!0},check:function(t){var e,i,s=this.pieces.length;if("piece"==t.type){for(e=0;e<s;e++)if(i=l(this.pieces[e],t))return this.rmove(i[0],i[1]),!0}else{var n,o=t.pieces.length;for(e=0;e<s;e++)for(n=0;n<o;n++)if(i=l(this.pieces[e],t.pieces[n]))return this.rmove(i[0],i[1]),!0}},rmove:function(t,e){var i,s=this.pieces.length;for(i=0;i<s;i++)this.pieces[i].rmove(t,e);this.tx=this.minPieceX.tx,this.ty=this.minPieceY.ty},add:function(){this.pieces=this.pieces.concat.apply(this.pieces,arguments),this.minPieceX=f(this.pieces,"tx"),this.minPieceY=f(this.pieces,"ty"),this.width=g(this.pieces,"tx").tx-this.minPieceX.tx,this.height=g(this.pieces,"ty").ty-this.minPieceY.ty,this.width+=this.pieces[0].width,this.height+=this.pieces[0].height,this.x=this.pieces[0].x,this.y=this.pieces[0].y,this.tx=this.minPieceX.tx,this.ty=this.minPieceY.ty}});function g(t,e){for(var i=t[0][e],s=0,n=1;n<t.length;n++)t[n][e]>i&&(i=t[n][e],s=n);return t[s]}function f(t,e){for(var i=t[0][e],s=0,n=1;n<t.length;n++)t[n][e]<i&&(i=t[n][e],s=n);return t[s]}Cevent.register("group",m),Cevent.register("piece",u)}(),function(){"use strict";var t,e="inside",i="outside",s=null,n=[e,i],o=0,h={spread:.7,offsetTop:0,maxWidth:1e3,maxHeight:1e3,defaultImage:"puzzle/default.jpg",piecesNumberTmpl:"%d деталей",redirect:"",border:!0,defaultPieces:10,shuffled:!1,rotatePieces:!0,numberOfPieces:[20,34,48,62,76,90],squarePieces:!1},a=document.documentElement,r=window.devicePixelRatio||1;function c(){return n[Util.randint(2)]}function d(t){return document.getElementById(t)}function l(){return window.devicePixelRatio||1}window.jigsaw={},jigsaw.Jigsaw=Class.extend({init:function(e){var i=new EventEmitter,s=this;this.opts=e=Util.extend(e||{},h),this.max_width=e.maxWidth,this.max_height=e.maxHeight,d("redirect-form").action=e.redirect,t=e.defaultImage,this.eventBus=i,this.ce=new Cevent("canvas"),this.ui=new jigsaw.UI(i,e.defaultPieces||10),this.tmp_img=document.createElement("img"),this.img=document.getElementById("image"),this.ctx=Util.getContext(this.img),this.preview=document.getElementById("image-preview"),this.previewCtx=Util.getContext(this.preview),this.parts=e.defaultPieces||10;var n=!1;this.ce.beforeDraw((function(){n&&s.ce.ctx.drawImage(s.preview,s.ce.cv.width/2-s.preview.width/0,0)})),i.on(jigsaw.Events.SHOW_PREVIEW,(function(){n=!n,s.ce.redraw()})),this.tmp_img.onload=function(){s.original=this,s.max_width=this.width,s.max_height=this.height,s.draw_image(this),Util.calcPieces({image:s.img,template:s.opts.piecesNumberTmpl,selected:s.parts,options:s.opts.numberOfPieces}),s.render()},this.tmp_img.onerror=function(){t&&s.set_image(t)},function(t,e,i){if(t.drag("*",{start:function(t,e){t.cv.style.cursor="move",t.lastX*=l(),t.lastY*=l(),this.handleX=t.lastX-this.tx,this.handleY=t.lastY-this.ty},move:function(t,e){t.x*=l(),t.y*=l(),t.x+=t.lastX-this.tx-this.handleX,t.y+=t.lastY-this.ty-this.handleY},afterMove:function(t,e){var i=~~(this.width/2),s=~~(this.height/2),n=this.x+this.tx+i,o=this.y+this.ty+s,h=t.cv.width,a=t.cv.height;this.rotation/45%2&&(i=this.diagonal/2,s=this.diagonal/2);var r=0,c=0;n-i<0?r=n-i:n+i>h&&(r=n+i-h),o-s<0?c=o-s:o+s>a&&(c=o+s-a),this.rmove(-r,-c)},end:function(i,s){if(i.cv.style.cursor="default",i.shuffled){for(var n=i.getAll("piece").concat(i.getAll("group")),o=0,h=n.length,a=this;o<h;o++)n[o]!==this&&a.check(n[o])&&(i.remove(a),i.remove(n[o]),i._curHover=i.group().get(-1),i._curHover.add(a.pieces||a,n[o].pieces||n[o]),playSound("clickit"),a=i._curHover,i.focused=null);!t.getAll("piece").length&&1==t.getAll("group").length&&t.shuffled&&(t.shuffled=!1,e.emit(jigsaw.Events.JIGSAW_COMPLETE)),"group"==a.type&&(i.remove(a),i._shapes.unshift(a))}}}).focus("*",(function(t,e){t.remove(this),t._shapes.push(this)})),Util.addEvent(t.cv,"contextmenu",(function(e){i&&t.focused&&(t.focused.rotation=(t.focused.rotation+45)%360,t.redraw()),e.preventDefault()})),!i)return;t.keydown("right",(function(){return this.focused&&(this.focused.rotation=(this.focused.rotation+45)%360),!1})).keydown("left",(function(){return this.focused&&(this.focused.rotation=(this.focused.rotation-45)%360),!1})),t.tap("*",(function(e,i){Cevent.isTouchDevice&&t.focused&&(t.focused.rotation=(t.focused.rotation+45)%360,t.redraw())}))}(this.ce,i,this.opts.rotatePieces),i.on(jigsaw.Events.JIGSAW_COMPLETE,(function(){s.ui.stop_clock(),e.redirect?s.redirect():s.ui.show_time()})),e.shuffled&&i.on(jigsaw.Events.RENDER_FINISH,this.shuffle.bind(this)),i.on(jigsaw.Events.PARTS_NUMBER_CHANGED,this.set_parts.bind(this)),i.on(jigsaw.Events.RENDER_REQUEST,this.render.bind(this)),i.on(jigsaw.Events.JIGSAW_SHUFFLE,this.shuffle.bind(this)),i.on(jigsaw.Events.JIGSAW_SET_IMAGE,this.set_image.bind(this)),i.on(jigsaw.Events.SHOW_EDGE,(function(){s.ce.find("#middle").attr("hide",!0),s.ce.find("#edge").attr("hide",!1),s.ce.redraw()})),i.on(jigsaw.Events.SHOW_MIDDLE,(function(){s.ce.find("#middle").attr("hide",!1),s.ce.find("#edge").attr("hide",!0),s.ce.redraw()})),i.on(jigsaw.Events.SHOW_ALL,(function(){s.ce.find("*").attr("hide",!1),s.ce.redraw()})),Util.addEvent(window,"resize",this.resize.bind(this)),this.resize(),this.set_image()},resize:function(){var t=this.ce.cv,e=a.clientWidth,i=a.clientHeight-45;t.width=e*l(),t.height=i*l(),t.style.width=e+"px",t.style.height=i+"px",this.ce.redraw(),Cevent.isTouchDevice&&Util.fullScreen()},redirect:function(){d("t").value=this.ui.time(),d("p").value=this.parts,d("redirect-form").submit()},set_parts:function(t){this.parts=t},set_image:function(e){this.ce.cv.className="loading",this.tmp_img.src=e||t},draw_image:function(t,e,i){var s,n,o=e||this.max_width*l(),h=i||this.max_height*l(),a=this.ctx;if(o>window.innerWidth/1.9||h>window.innerHeight/1.46){var r=Math.min(window.innerHeight/1.46/h,window.innerWidth/1.9/o);o*=r,h*=r}if(t.width>o||t.height>h){var c=Math.min(o/t.width,h/t.height);s=~~(t.width*c)*l(),n=~~(t.height*c)*l(),a.canvas.width=s,a.canvas.height=n,a.drawImage(t,0,0,t.width,t.height,0,0,s,n)}else a.canvas.width=t.width*l(),a.canvas.height=t.height*l(),a.drawImage(t,0,0,t.width,t.height,0,0,a.canvas.width,a.canvas.height)},clear:function(){this.ce._shapes=[]},shuffle:function(){var t=this.ce.getAll("piece");if(this.__pieces){this.ce._shapes=t=this.__pieces.slice(0),this.ce.clear();var e,i,s=t.length,n=1.25*t[0].size,o=this.opts.spread,h=(document.documentElement.clientWidth,(document.documentElement.clientHeight-50)*r),a=.8*document.documentElement.clientWidth-n|0,c=document.documentElement.clientHeight*o*r,d=~~((h-c)/2);for(e=0;e<s;e++)(i=t[e]).tx=.5*Util.randint(5)*a*r+.175*(i.tx-r)+n/2*r|0,i.tx=Util.randint(2)*a*r+.1175*(i.tx-r)+n/2*r|0,i.ty=Util.randint(c)+i.ty%1e-6+d,this.opts.rotatePieces&&(i.rotation=90*Util.randint(4));this.opts.shuffled&&(this.ce.cv.className="",this.ui.init_clock()),this.ce.find("*").attr({hide:!1}),this.ce.shuffled=!0,this.ce.redraw()}},render:function(){this.opts.shuffled?(this.ce.cv.className="loading",this.ce.clear(),this.ui.stop_clock()):this.ce.cv.className="",this.ce.shuffled=!1;var t,n,h,a,r,d=[],u=[],m=this.img.width,g=this.img.height,f=~~Math.sqrt(m*g/this.parts),p=~~(m/f),w=~~(g/f),v=0,E=0,x=++o;for(this.flag=x;p*w<this.parts;)f--,p=~~(m/f),w=~~(g/f);var _=~~(m/p),y=~~(g/w);_=_%2?_:_-1,y=y%2?y:y-1,r=~~(document.documentElement.clientWidth/2*l()-_*p/2),this.clear();var I=~~((m-p*_)/2),S=~~((g-w*y)/2);I=I>=0?I:0,S=S>=0?S:0,this.preview.style.marginTop=this.opts.offsetTop+"px",this.preview.width=_*p,this.preview.height=y*w,this.preview.style.width=this.preview.width/l()+"px",this.preview.style.height=this.preview.height/l()+"px",this.previewCtx.globalAlpha=.5,this.previewCtx.drawImage(this.img,I,S,_*p,y*w,0,0,_*p,y*w),function o(){if(v<p&&x==this.flag)return E<w?(t=0==E?s:h==e?i:e,n=v==p-1?s:c(),h=E==w-1?s:c(),a=0==v?0:u[E]==e?i:e,this.ce.piece(_*v,y*E+this.opts.offsetTop,window.G_vmlCanvasManager?this.tmp_img:this.img,_,y,[t,n,h,a],this.opts.squarePieces).attr({col:v,row:E,offset:r,stroke:this.opts.border?"black":""}).get(-1).render(I,S-this.opts.offsetTop),this.opts.shuffled||this.ce.redraw(),0==E||0==v||v==p-1||E==w-1?this.ce.addId("edge"):this.ce.addId("middle"),d.push(n),E++):(v++,E=0,u=d,d=[]),void setTimeout(o.bind(this),20);this.flag==x&&(this.__pieces=this.ce.get().sort(compareRandom),this.ce.redraw(),this.eventBus.emit(jigsaw.Events.RENDER_FINISH))}.bind(this)()}}),EventEmitter.mixin(jigsaw.Jigsaw)}(),function(){"use strict";var t=function(t){return document.getElementById(t)},e=0,i=window.devicePixelRatio||1;jigsaw.UI=Class.extend({init:function(e,i){this.eventBus=e,this.clock=t("clock"),function(t,e){function i(t){var i=t[0];if(i.type.match(/image.*/)){var s=new FileReader;s.onload=function(t){e.emit(jigsaw.Events.JIGSAW_SET_IMAGE,t.target.result)},s.readAsDataURL(i)}else alert("Пожалуйста, выберите изображение.")}document.getElementById("image-input").addEventListener("change",(function(t){i(t.target.files)})),Util.$("set-parts").change((function(){e.emit(jigsaw.Events.PARTS_NUMBER_CHANGED,+this.value),e.emit(jigsaw.Events.RENDER_REQUEST)})),Cevent.addEventListener("game-options","mousedown",(function(t){var i=t.target||t.srcElement;jigsaw.Events[i.id]&&(t.preventDefault(),t.stopPropagation(),e.emit(jigsaw.Events[i.id]))}))}(0,e),e.on(jigsaw.Events.JIGSAW_SHUFFLE,this.init_clock.bind(this)),e.on(jigsaw.Events.SHOW_PREVIEW,this.show_preview.bind(this)),e.on(jigsaw.Events.SHOW_HELP,this.show_help.bind(this)),e.on(jigsaw.Events.SHOW_FILEPICKER,(function(){document.getElementById("image-input").click()}))},stop_clock:function(){e++},init_clock:function(){var t=this;this.ini=(new Date).getTime(),this.uuid=e,function i(){t.uuid==e&&(t.clock.innerHTML=t.time(),setTimeout(i,1e3))}()},show_preview:function(){var e=t("image-preview");e.className="show"==e.className?"hide":"show",e.style.marginLeft=-e.width/2/i+"px"},show_time:function(){this.show_modal("congrat"),t("time").innerHTML=this.clock.innerHTML,t("time-input").value=this.clock.innerHTML},time:function(){var t=~~(((new Date).getTime()-this.ini)/1e3),e=t%60,i=~~(t/60),s=~~(i/60);return(s>9?s:"0"+s)+":"+((i%=60)>9?i:"0"+i%60)+":"+(e>9?e:"0"+e)},show_modal:function(t){game.Modal.open(t)},show_help:function(){this.show_modal("help")}})}(),jigsaw.Events={PARTS_NUMBER_CHANGED:"PartsNumberChanged",RENDER_REQUEST:"RenderRequestEvent",RENDER_FINISH:"RenderFinishEvent",JIGSAW_RENDERED:"JigsawRenderedEvent",JIGSAW_SET_IMAGE:"JigsawSetImageEvent",JIGSAW_SHUFFLE:"JigsawShuffleEvent",SHOW_PREVIEW:"JigsawShowPreview",SHOW_HELP:"JigsawShowHelp",SHOW_FILEPICKER:"JigsawShowFilepicker",SHOW_EDGE:"ShowEdgeEvent",SHOW_MIDDLE:"ShowMiddleEvent",SHOW_ALL:"ShowAllEvent",JIGSAW_COMPLETE:"JigsawCompleteEvent"},function(t,e,i){"use strict";var s=function(e){return t.getElementById(e)},n=s("modal-window"),o=s("modal-window-msg"),h=s("modal-window-close"),a=s("overlay");function r(e){e&&e.preventDefault(),n.className="modal hide",a.className="hide";var i=game.Modal.currentContent;return setTimeout((function(){i&&(i.className="hide",t.body.appendChild(i))}),600),!1}var c=Cevent.isTouchDevice?"touchstart":"click";Cevent.addEventListener(a,c,r),Cevent.addEventListener(h,c,r),e.game=e.game||{},game.Modal={open:function(t,e){var i=n.style,h=s(t);h.className="",game.Modal.currentContent=h,o.appendChild(h);var r=n.offsetWidth;i.marginLeft=-r/2+"px",n.className="modal",a.className=""},close:r}}(document,window),document,window,jigsaw.GET=function(){if(!location.query){for(var t=location.search.replace(/^[?]/,"").split("&"),e=0,i=t.length,s={};e<i;e++)t[e]&&(part=t[e].split("="),s[unescape(part[0])]=unescape(part[1]));return s}}();var Soundfx={clickit:new Audio("puzzle/stuck.mp3"),wingame:new Audio("puzzle/success.mp3")};function playSound(t){Soundfx[t].load(),Soundfx[t].play()}